<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Wallet API - Mevacoin</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 900px;
    margin: 24px auto;
    background: #f0f2f5;
    padding: 24px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    color: #222;
}
h1 { text-align: center; color: #1976d2; margin-bottom: 18px; }
label { display:block; margin-top:10px; font-weight:600; }
input, textarea, select { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
textarea { min-height:90px; font-family: monospace; }
.row { display:flex; gap:10px; }
.col { flex:1; }
button { margin:8px 6px 0 0; padding:8px 12px; border-radius:8px; border:none; background:#1976d2; color:#fff; cursor:pointer; font-weight:700; }
button.warn { background:#f57c00; }
#output { margin-top:16px; padding:12px; background:#272822; color:#f8f8f2; border-radius:8px; white-space:pre-wrap; max-height:420px; overflow:auto; font-size:13px; }
.section { margin-top:14px; padding:12px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
.small { font-size:12px; color:#666; }
.grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.inline { display:inline-block; vertical-align:middle; }
</style>
</head>
<body>

<h1>Wallet API - Mevacoin</h1>

<div class="section">
    <label>Seleziona wallet (file .wallet)</label>
    <input type="file" id="walletFile" accept=".wallet" />
    <input type="hidden" id="walletName" value="testwallet_1.wallet" />
    <label>Password API / Wallet</label>
    <input id="walletPass" value="desy2011" />
</div>

<div class="section grid2">
    <div>
        <label>Indirizzo / Address</label>
        <input id="txAddress" placeholder="indirizzo" />
    </div>
    <div>
        <label>Importo (unit√† interne)</label>
        <input id="txAmount" type="number" placeholder="Es. 1000000" />
    </div>
</div>

<div class="section">
    <label>Payment ID (facoltativo)</label>
    <input id="txPaymentID" placeholder="payment id" />
    <label>Private Spend Key (per import keys)</label>
    <input id="spendKey" placeholder="private spend key" />
    <label>Private View Key (per import keys)</label>
    <input id="viewKey" placeholder="private view key" />
    <label>Mnemonic seed (per import seed)</label>
    <textarea id="mnemonic" placeholder="seed mnemonico..."></textarea>
</div>

<div class="section">
    <h3>Wallet</h3>
    <button id="btnCreate">Crea Wallet</button>
    <button id="btnOpen">Apri Wallet</button>
    <button id="btnClose">Chiudi Wallet</button>
    <button id="btnSave">Salva Wallet</button>
    <button id="btnDownloadWallet">Scarica Wallet</button>
    <button id="btnImportSeed">Importa da Seed</button>
    <button id="btnImportKeys">Importa da Keys</button>
    <button id="btnShowKeys">Mostra Keys</button>
    <button id="btnShowMnemonic">Mostra Mnemonic (per indirizzo)</button>
</div>

<div class="section">
    <h3>Indirizzi / Bilanci</h3>
    <button id="btnAddresses">Lista Indirizzi</button>
    <button id="btnPrimary">Indirizzo Principale</button>
    <button id="btnCreateAddr">Crea Nuovo Indirizzo</button>
    <button id="btnBalance">Bilancio Totale</button>
    <button id="btnBalanceAddr">Bilancio per Indirizzo</button>
    <button id="btnValidateAddr" class="warn">Valida Indirizzo</button>
</div>

<div class="section">
    <h3>Transazioni</h3>
    <div class="row">
        <div class="col"><button id="btnListTx">Lista Transazioni</button></div>
        <div class="col"><button id="btnUnconfirmed">Unconfirmed Outgoing</button></div>
    </div>
    <div style="margin-top:8px;">
        <button id="btnSend">Invia Transazione (basic)</button>
        <button id="btnPrepare">Prepara Transazione</button>
    </div>
    <label class="small">Per altre operazioni avanzate usa il pannello <strong>Custom request</strong> sotto.</label>
</div>

<div class="section">
    <h3>Stato / Nodo / Export</h3>
    <button id="btnStatus">Stato Wallet</button>
    <button id="btnExport">Esporta JSON (server)</button>
    <div style="margin-top:10px;">
        <label>Node (host:port) per set</label>
        <input id="nodeAddr" placeholder="node.example.org:1234" />
        <button id="btnNodeGet">Get Node</button>
        <button id="btnNodeSet">Set Node</button>
    </div>
</div>

<div class="section">
    <h3>Custom request</h3>
    <label>Endpoint (es. /transactions/send/basic)</label>
    <input id="customEndpoint" placeholder="/transactions/send/basic" />
    <label>Method</label>
    <select id="customMethod"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
    <label>JSON body (facoltativo)</label>
    <textarea id="customData" placeholder='{"address":"...","amount":1000000}'></textarea>
    <div style="margin-top:8px;">
        <button id="btnCustom">Esegui Custom</button>
    </div>
</div>

<pre id="output">Usa i pulsanti per interagire con il wallet...</pre>

<script>
const out = document.getElementById('output');

async function callApi(bodyObj) {
    out.textContent = 'Eseguo...';
    try {
        const res = await fetch('api.php', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(bodyObj)
        });
        const text = await res.text();
        try {
            const json = JSON.parse(text);
            out.innerText = JSON.stringify(json, null, 2);
        } catch(e) {
            out.innerText = text;
        }
    } catch (e) {
        out.innerText = 'Errore fetch: ' + e.message;
    }
}

function baseParams() {
    return {
        filename: document.getElementById('walletName').value.trim(),
        password: document.getElementById('walletPass').value.trim()
    };
}

// Selezione file wallet
document.getElementById('walletFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(file) {
        document.getElementById('walletName').value = file.name;
        out.textContent = 'Wallet selezionato: ' + file.name;
    }
});

// Wallet buttons
document.getElementById('btnCreate').addEventListener('click', ()=> callApi(Object.assign({action:'create'}, baseParams())));
document.getElementById('btnOpen').addEventListener('click', ()=> callApi(Object.assign({action:'open'}, baseParams())));
document.getElementById('btnClose').addEventListener('click', ()=> callApi(Object.assign({action:'close'}, baseParams())));
document.getElementById('btnSave').addEventListener('click', ()=> callApi(Object.assign({action:'save'}, baseParams())));

document.getElementById('btnImportSeed').addEventListener('click', ()=>{
    const m = document.getElementById('mnemonic').value.trim();
    if(!m) { alert('Inserisci il seed!'); return; }
    callApi(Object.assign({action:'import_seed', mnemonic:m}, baseParams()));
});
document.getElementById('btnImportKeys').addEventListener('click', ()=>{
    const s = document.getElementById('spendKey').value.trim();
    const v = document.getElementById('viewKey').value.trim();
    if(!s || !v) { alert('Inserisci spend+view key'); return; }
    callApi(Object.assign({action:'import_key', spend_key:s, view_key:v}, baseParams()));
});

// SHOW KEYS e MNEMONIC
document.getElementById('btnShowKeys').addEventListener('click', ()=> callApi(Object.assign({action:'keys'}, baseParams())));
document.getElementById('btnShowMnemonic').addEventListener('click', ()=> {
    const a = document.getElementById('txAddress').value.trim();
    if(!a) { alert('Inserisci indirizzo per il mnemonic'); return; }
    callApi(Object.assign({action:'keys_mnemonic', address:a}, baseParams()));
});

// Addresses / Balance
document.getElementById('btnAddresses').addEventListener('click', ()=> callApi(Object.assign({action:'addresses'}, baseParams())));
document.getElementById('btnPrimary').addEventListener('click', ()=> callApi(Object.assign({action:'address'}, baseParams())));
document.getElementById('btnCreateAddr').addEventListener('click', ()=> callApi(Object.assign({action:'address_create'}, baseParams())));
document.getElementById('btnBalance').addEventListener('click', ()=> callApi(Object.assign({action:'balance'}, baseParams())));
document.getElementById('btnBalanceAddr').addEventListener('click', ()=> {
    const a = document.getElementById('txAddress').value.trim();
    if(!a) { alert('Inserisci indirizzo'); return; }
    callApi(Object.assign({action:'balance_addr', address:a}, baseParams()));
});
document.getElementById('btnValidateAddr').addEventListener('click', ()=> {
    const a = document.getElementById('txAddress').value.trim();
    if(!a) { alert('Inserisci indirizzo'); return; }
    callApi(Object.assign({action:'addresses_validate', address:a}, baseParams()));
});

// Transactions
document.getElementById('btnListTx').addEventListener('click', ()=> callApi(Object.assign({action:'transactions'}, baseParams())));
document.getElementById('btnUnconfirmed').addEventListener('click', ()=> callApi(Object.assign({action:'transactions_unconfirmed'}, baseParams())));
document.getElementById('btnSend').addEventListener('click', ()=> {
    const a = document.getElementById('txAddress').value.trim();
    const amt = parseInt(document.getElementById('txAmount').value.trim()) || 0;
    const pid = document.getElementById('txPaymentID').value.trim();
    if(!a || !amt) { alert('Inserisci indirizzo e importo'); return; }
    callApi(Object.assign({action:'send', address:a, amount:amt, paymentID:pid}, baseParams()));
});
document.getElementById('btnPrepare').addEventListener('click', ()=> {
    const a = document.getElementById('txAddress').value.trim();
    const amt = parseInt(document.getElementById('txAmount').value.trim()) || 0;
    const pid = document.getElementById('txPaymentID').value.trim();
    if(!a || !amt) { alert('Inserisci indirizzo e importo'); return; }
    callApi(Object.assign({action:'transactions_prepare_basic', address:a, amount:amt, paymentID:pid}, baseParams()));
});

// Download wallet
document.getElementById('btnDownloadWallet').addEventListener('click', async ()=>{
    const params = baseParams();
    params.action = 'download_wallet';
    out.textContent = 'Generazione token per download...';
    try {
        const res = await fetch('api.php', {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(params)
        });
        const json = await res.json();
        if(json.status === 'success' && json.token) {
            const token = json.token;
            const url = `download_wallet.php?token=${token}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = params.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            out.textContent = 'Download avviato...';
        } else {
            out.textContent = 'Errore generazione token: '+JSON.stringify(json);
        }
    } catch(e) {
        out.textContent = 'Errore fetch: '+e.message;
    }
});

// Status / Node / Export
document.getElementById('btnStatus').addEventListener('click', ()=> callApi(Object.assign({action:'status'}, baseParams())));
document.getElementById('btnExport').addEventListener('click', ()=> {
    const path = prompt('Percorso file sul server dove esportare il JSON','/tmp/wallet_export.json');
    if(!path) return;
    callApi(Object.assign({action:'export_json', filepath:path}, baseParams()));
});
document.getElementById('btnNodeGet').addEventListener('click', ()=> callApi(Object.assign({action:'node_get'}, baseParams())));
document.getElementById('btnNodeSet').addEventListener('click', ()=> {
    const node = document.getElementById('nodeAddr').value.trim();
    if(!node) { alert('Inserisci node:port'); return; }
    const parts = node.split(':');
    callApi(Object.assign({action:'node_put', node:parts[0], port: parseInt(parts[1]||0)}, baseParams()));
});

// Custom
document.getElementById('btnCustom').addEventListener('click', ()=> {
    const endp = document.getElementById('customEndpoint').value.trim();
    const method = document.getElementById('customMethod').value.trim();
    let data = null;
    try { data = document.getElementById('customData').value.trim() ? JSON.parse(document.getElementById('customData').value) : null; } catch(e) { alert('JSON body non valido'); return; }
    if(!endp.startsWith('/')) { alert('Endpoint deve iniziare con /'); return; }
    callApi(Object.assign({action:'custom', endpoint:endp, method:method, data:data}, baseParams()));
});
</script>
</body>
</html>
